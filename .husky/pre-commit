#!/bin/sh
echo "ğŸš€ Running pre-commit checks..."

# Try to find bun in common locations if not in PATH
if ! command -v bun >/dev/null 2>&1; then
  if [ -f "$HOME/.bun/bin/bun" ]; then
    export PATH="$HOME/.bun/bin:$PATH"
  elif [ -f "/opt/homebrew/bin/bun" ]; then
    export PATH="/opt/homebrew/bin:$PATH"
  elif [ -f "$HOME/.local/bin/bun" ]; then
    export PATH="$HOME/.local/bin:$PATH"
  fi
fi

# Verify bun is available
if ! command -v bun >/dev/null 2>&1; then
  echo "âŒ Error: bun command not found. Please ensure bun is installed and in your PATH."
  echo "   You can install bun from: https://bun.sh"
  exit 1
fi

pids=""

bun run lint & pids="$pids $!"
bun run test-ci & pids="$pids $!"
bun run check-format & pids="$pids $!"
bun run type-check & pids="$pids $!"

fail=0
for pid in $pids; do
  if ! wait "$pid"; then
    fail=1
  fi
done

if [ $fail -ne 0 ]; then
  echo "ğŸš¨ Pre-commit checks failed. Please fix the above issues before committing."
  exit 1
fi

echo "âœ… All pre-commit checks passed."
